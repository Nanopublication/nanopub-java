<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Import.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nanopub</a> &gt; <a href="index.source.html" class="el_package">org.nanopub.op</a> &gt; <span class="el_source">Import.java</span></div><h1>Import.java</h1><pre class="source lang-java linenums">package org.nanopub.op;

import com.beust.jcommander.ParameterException;
import net.trustyuri.TrustyUriException;
import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.Statement;
import org.eclipse.rdf4j.model.ValueFactory;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.model.vocabulary.*;
import org.eclipse.rdf4j.rio.*;
import org.eclipse.rdf4j.rio.helpers.AbstractRDFHandler;
import org.nanopub.*;
import org.nanopub.trusty.TempUriReplacer;
import org.nanopub.vocabulary.NP;
import org.nanopub.vocabulary.PAV;
import org.nanopub.vocabulary.SCHEMA;

import java.io.*;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.List;
import java.util.zip.GZIPInputStream;
import java.util.zip.GZIPOutputStream;

/**
 * Command-line utility to import RDF data into nanopublications.
 */
<span class="nc" id="L28">public class Import extends CliRunner {</span>

<span class="nc" id="L30">    @com.beust.jcommander.Parameter(description = &quot;input-file&quot;, required = true)</span>
    private List&lt;File&gt; inputFiles = new ArrayList&lt;&gt;();

<span class="nc" id="L33">    @com.beust.jcommander.Parameter(names = &quot;-t&quot;, description = &quot;Input type (currently supported: cedar)&quot;, required = true)</span>
    private String type = null;

    @com.beust.jcommander.Parameter(names = &quot;-o&quot;, description = &quot;Output file&quot;)
    private File outputFile;

    @com.beust.jcommander.Parameter(names = &quot;--in-format&quot;, description = &quot;Format of the input: ttl, nt, trig, nq, trix, trig.gz, ...&quot;)
    private String inFormat;

    @com.beust.jcommander.Parameter(names = &quot;--out-format&quot;, description = &quot;Format of the output nanopubs: trig, nq, trix, trig.gz, ...&quot;)
    private String outFormat;

    /**
     * Main method to run the import operation.
     *
     * @param args Command-line arguments
     */
    public static void main(String[] args) {
        try {
<span class="nc" id="L52">            Import obj = CliRunner.initJc(new Import(), args);</span>
<span class="nc bnc" id="L53" title="All 2 branches missed.">            if (obj.inputFiles.size() != 1) {</span>
<span class="nc" id="L54">                obj.getJc().usage();</span>
<span class="nc" id="L55">                System.exit(1);</span>
            }
<span class="nc" id="L57">            obj.run();</span>
<span class="nc" id="L58">        } catch (ParameterException ex) {</span>
<span class="nc" id="L59">            System.exit(1);</span>
<span class="nc" id="L60">        } catch (Exception ex) {</span>
<span class="nc" id="L61">            ex.printStackTrace();</span>
<span class="nc" id="L62">            System.exit(1);</span>
<span class="nc" id="L63">        }</span>
<span class="nc" id="L64">    }</span>

    private RDFFormat rdfInFormat, rdfOutFormat;
<span class="nc" id="L67">    private OutputStream outputStream = System.out;</span>

    private void run() throws IOException, RDFParseException, RDFHandlerException, MalformedNanopubException, TrustyUriException {

<span class="nc" id="L71">        File inputFile = inputFiles.getFirst();</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (inFormat != null) {</span>
<span class="nc" id="L73">            rdfInFormat = Rio.getParserFormatForFileName(&quot;file.&quot; + inFormat).orElse(null);</span>
        } else {
<span class="nc" id="L75">            rdfInFormat = Rio.getParserFormatForFileName(inputFile.toString()).orElse(null);</span>
        }
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (outputFile == null) {</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">            if (outFormat == null) {</span>
<span class="nc" id="L79">                outFormat = &quot;trig&quot;;</span>
            }
<span class="nc" id="L81">            rdfOutFormat = Rio.getParserFormatForFileName(&quot;file.&quot; + outFormat).orElse(null);</span>
        } else {
<span class="nc" id="L83">            rdfOutFormat = Rio.getParserFormatForFileName(outputFile.getName()).orElse(null);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (outputFile.getName().endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L85">                outputStream = new GZIPOutputStream(new FileOutputStream(outputFile));</span>
            } else {
<span class="nc" id="L87">                outputStream = new FileOutputStream(outputFile);</span>
            }
        }

<span class="nc" id="L91">        List&lt;Nanopub&gt; nanopubs = createNanopubs(inputFile, type, rdfInFormat);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        for (Nanopub np : nanopubs) {</span>
<span class="nc" id="L93">            NanopubUtils.writeToStream(np, outputStream, rdfOutFormat);</span>
<span class="nc" id="L94">        }</span>

<span class="nc" id="L96">        outputStream.flush();</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (outputStream != System.out) {</span>
<span class="nc" id="L98">            outputStream.close();</span>
        }
<span class="nc" id="L100">    }</span>

    /**
     * Creates nanopublications from the given RDF file.
     *
     * @param file   the RDF file to read
     * @param type   the type of import
     * @param format the RDF format of the input file
     * @return a list of created nanopublications
     * @throws java.io.IOException                       if an I/O error occurs
     * @throws org.eclipse.rdf4j.rio.RDFParseException   if the RDF data cannot be parsed
     * @throws org.eclipse.rdf4j.rio.RDFHandlerException if there is an error handling the RDF data
     * @throws org.nanopub.MalformedNanopubException     if the nanopublication is malformed
     */
    public static List&lt;Nanopub&gt; createNanopubs(File file, String type, RDFFormat format) throws IOException, RDFParseException, RDFHandlerException, MalformedNanopubException {
        final NanopubImporter importer;
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (&quot;cedar&quot;.equals(type)) {</span>
<span class="nc" id="L117">            importer = new CedarNanopubImporter();</span>
        } else {
<span class="nc" id="L119">            throw new IllegalArgumentException(&quot;Unknown import type: &quot; + type);</span>
        }

        InputStream in;
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (file.getName().matches(&quot;.*\\.(gz|gzip)&quot;)) {</span>
<span class="nc" id="L124">            in = new GZIPInputStream(new BufferedInputStream(new FileInputStream(file)));</span>
        } else {
<span class="nc" id="L126">            in = new BufferedInputStream(new FileInputStream(file));</span>
        }
<span class="nc" id="L128">        RDFParser p = NanopubUtils.getParser(format);</span>
<span class="nc" id="L129">        final List&lt;Statement&gt; statements = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L130">        RDFHandler rdfHandler = new AbstractRDFHandler() {</span>

            @Override
            public void handleStatement(Statement st) throws RDFHandlerException {
<span class="nc" id="L134">                statements.add(st);</span>
<span class="nc" id="L135">                super.handleStatement(st);</span>
<span class="nc" id="L136">            }</span>

        };
<span class="nc" id="L139">        p.setRDFHandler(rdfHandler);</span>
        try {
<span class="nc" id="L141">            p.parse(new InputStreamReader(in, StandardCharsets.UTF_8), &quot;&quot;);</span>
        } finally {
<span class="nc" id="L143">            in.close();</span>
        }
<span class="nc" id="L145">        importer.readStatements(statements);</span>
<span class="nc" id="L146">        importer.finalizeNanopubs();</span>
<span class="nc" id="L147">        return importer.getNanopubs();</span>
    }


    /**
     * Interface for importing RDF data into nanopublications.
     */
    public static interface NanopubImporter {

        /**
         * Reads RDF statements and prepares them for nanopublication creation.
         *
         * @param statements the list of RDF statements to read
         */
        public void readStatements(List&lt;Statement&gt; statements);

        /**
         * Finalizes the nanopublications after all statements have been read.
         */
        public void finalizeNanopubs();

        /**
         * Returns the list of created nanopublications.
         *
         * @return a list of nanopublications
         */
        public List&lt;Nanopub&gt; getNanopubs();

    }

    /**
     * Importer for Cedar template instances into nanopublications.
     */
    public static class CedarNanopubImporter implements NanopubImporter {

        private String npIriString;
        private IRI npIri;
        private NanopubCreator npCreator;
        private List&lt;Nanopub&gt; nanopubs;

        /**
         * Default constructor for CedarNanopubImporter.
         */
<span class="nc" id="L190">        public CedarNanopubImporter() {</span>
<span class="nc" id="L191">        }</span>

        /**
         * Read RDF statements and prepare them for nanopublication creation.
         *
         * @param statements the list of RDF statements to read
         */
        @Override
        public void readStatements(List&lt;Statement&gt; statements) {
<span class="nc" id="L200">            String cedarId = getCedarId(statements);</span>
<span class="nc" id="L201">            npIriString = TempUriReplacer.tempUri + cedarId + &quot;#&quot;;</span>
<span class="nc" id="L202">            npIri = vf.createIRI(npIriString);</span>

<span class="nc" id="L204">            npCreator = new NanopubCreator(npIri);</span>
<span class="nc" id="L205">            addNamespaces();</span>
<span class="nc" id="L206">            npCreator.setAssertionUri(npIriString + &quot;assertion&quot;);</span>
<span class="nc" id="L207">            npCreator.setProvenanceUri(npIriString + &quot;provenance&quot;);</span>
<span class="nc" id="L208">            npCreator.setPubinfoUri(npIriString + &quot;pubinfo&quot;);</span>

<span class="nc" id="L210">            npCreator.addPubinfoStatement(vf.createIRI(&quot;https://repo.metadatacenter.org/template-instances/&quot; + cedarId), DCTERMS.HAS_VERSION, npIri);</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">            for (Statement st : statements) {</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                if (st.getPredicate().stringValue().equals(&quot;http://open-services.net/ns/core#modifiedBy&quot;)) {</span>
<span class="nc" id="L214">                    npCreator.addProvenanceStatement(PAV.AUTHORED_BY, st.getObject());</span>
<span class="nc" id="L215">                    npCreator.addPubinfoStatement(DCTERMS.CREATOR, st.getObject());</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                } else if (st.getPredicate().stringValue().equals(PAV.LAST_UPDATED_ON.stringValue())) {</span>
<span class="nc" id="L217">                    npCreator.addPubinfoStatement(DCTERMS.CREATED, st.getObject());</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">                } else if (st.getPredicate().stringValue().equals(PAV.CREATED_BY.stringValue())) {</span>
<span class="nc" id="L219">                    npCreator.addPubinfoStatements(st);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">                } else if (st.getPredicate().stringValue().equals(PAV.CREATED_ON.stringValue())) {</span>
<span class="nc" id="L221">                    npCreator.addPubinfoStatements(st);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                } else if (st.getPredicate().stringValue().equals(SCHEMA.DESCRIPTION.stringValue())) {</span>
<span class="nc" id="L223">                    npCreator.addPubinfoStatements(st);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">                } else if (st.getPredicate().stringValue().equals(SCHEMA.IS_BASED_ON.stringValue())) {</span>
<span class="nc" id="L225">                    npCreator.addPubinfoStatements(st);</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                } else if (st.getPredicate().stringValue().equals(SCHEMA.NAME.stringValue())) {</span>
<span class="nc" id="L227">                    npCreator.addPubinfoStatements(st);</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                } else if (st.getSubject() instanceof IRI) {</span>
<span class="nc" id="L229">                    String s = st.getSubject().stringValue().replaceFirst(&quot;^https://repo.metadatacenter.org/template-instances/.*$&quot;, npIriString + &quot;subj&quot;);</span>
<span class="nc" id="L230">                    npCreator.addAssertionStatements(vf.createStatement(vf.createIRI(s), st.getPredicate(), st.getObject()));</span>
<span class="nc" id="L231">                } else {</span>
<span class="nc" id="L232">                    npCreator.addAssertionStatements(st);</span>
                }
<span class="nc" id="L234">            }</span>
<span class="nc" id="L235">        }</span>

        private String getCedarId(List&lt;Statement&gt; statements) {
<span class="nc bnc" id="L238" title="All 2 branches missed.">            for (Statement st : statements) {</span>
<span class="nc" id="L239">                String s = st.getSubject().stringValue();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">                if (s.startsWith(&quot;https://repo.metadatacenter.org/template-instances/&quot;)) {</span>
<span class="nc" id="L241">                    return s.replaceFirst(&quot;^https://repo.metadatacenter.org/template-instances/&quot;, &quot;&quot;);</span>
                }
<span class="nc" id="L243">            }</span>
<span class="nc" id="L244">            throw new RuntimeException(&quot;No Cedar ID found&quot;);</span>
        }

        private void addNamespaces() {
<span class="nc" id="L248">            npCreator.addNamespace(&quot;&quot;, npIriString);</span>
<span class="nc" id="L249">            npCreator.addNamespace(RDF.NS);</span>
<span class="nc" id="L250">            npCreator.addNamespace(RDFS.NS);</span>
<span class="nc" id="L251">            npCreator.addNamespace(&quot;rdfg&quot;, &quot;http://www.w3.org/2004/03/trix/rdfg-1/&quot;);</span>
<span class="nc" id="L252">            npCreator.addNamespace(XSD.NS);</span>
<span class="nc" id="L253">            npCreator.addNamespace(OWL.NS);</span>
<span class="nc" id="L254">            npCreator.addNamespace(&quot;dct&quot;, DCTERMS.NAMESPACE);</span>
<span class="nc" id="L255">            npCreator.addNamespace(&quot;dce&quot;, DC.NAMESPACE);</span>
<span class="nc" id="L256">            npCreator.addNamespace(PAV.PREFIX, PAV.NAMESPACE);</span>
<span class="nc" id="L257">            npCreator.addNamespace(NP.PREFIX, NP.NAMESPACE);</span>
<span class="nc" id="L258">            npCreator.addNamespace(&quot;skos&quot;, &quot;http://www.w3.org/TR/skos-reference/skos-owl1-dl#&quot;);</span>
<span class="nc" id="L259">            npCreator.addNamespace(&quot;obo&quot;, &quot;http://purl.obolibrary.org/obo/&quot;);</span>
<span class="nc" id="L260">            npCreator.addNamespace(SCHEMA.PREFIX, SCHEMA.NAMESPACE);</span>
<span class="nc" id="L261">            npCreator.addNamespace(&quot;cedar-user&quot;, &quot;https://metadatacenter.org/users/&quot;);</span>
<span class="nc" id="L262">            npCreator.addNamespace(&quot;cedar-temp&quot;, &quot;https://repo.metadatacenter.org/templates/&quot;);</span>
<span class="nc" id="L263">            npCreator.addNamespace(&quot;cedar-tempinst&quot;, &quot;https://repo.metadatacenter.org/template-instances/&quot;);</span>
<span class="nc" id="L264">            npCreator.addNamespace(&quot;cedar-tempelinst&quot;, &quot;https://repo.metadatacenter.org/template-element-instances/&quot;);</span>
<span class="nc" id="L265">            npCreator.addNamespace(&quot;cedar-prop&quot;, &quot;https://schema.metadatacenter.org/properties/&quot;);</span>
<span class="nc" id="L266">        }</span>

        /**
         * Finalizes the nanopublications after all statements have been read.
         */
        @Override
        public void finalizeNanopubs() {
            try {
<span class="nc" id="L274">                nanopubs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L275">                nanopubs.add(npCreator.finalizeNanopub());</span>
<span class="nc" id="L276">            } catch (MalformedNanopubException ex) {</span>
<span class="nc" id="L277">                throw new RuntimeException(ex);</span>
<span class="nc" id="L278">            }</span>
<span class="nc" id="L279">        }</span>

        /**
         * Returns the list of created nanopublications.
         *
         * @return a list of nanopublications
         */
        @Override
        public List&lt;Nanopub&gt; getNanopubs() {
<span class="nc" id="L288">            return nanopubs;</span>
        }

    }

<span class="nc" id="L293">    private static ValueFactory vf = SimpleValueFactory.getInstance();</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>