<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LegacySignatureUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nanopub</a> &gt; <a href="index.source.html" class="el_package">org.nanopub.extra.security</a> &gt; <span class="el_source">LegacySignatureUtils.java</span></div><h1>LegacySignatureUtils.java</h1><pre class="source lang-java linenums">package org.nanopub.extra.security;

import jakarta.xml.bind.DatatypeConverter;
import net.trustyuri.TrustyUriException;
import net.trustyuri.TrustyUriUtils;
import net.trustyuri.rdf.RdfFileContent;
import net.trustyuri.rdf.RdfHasher;
import net.trustyuri.rdf.RdfPreprocessor;
import net.trustyuri.rdf.TransformRdf;
import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.Literal;
import org.eclipse.rdf4j.model.Statement;
import org.eclipse.rdf4j.model.ValueFactory;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.rio.RDFFormat;
import org.eclipse.rdf4j.rio.RDFHandlerException;
import org.nanopub.MalformedNanopubException;
import org.nanopub.Nanopub;
import org.nanopub.NanopubRdfHandler;
import org.nanopub.NanopubUtils;
import org.nanopub.trusty.TrustyNanopubUtils;
import org.nanopub.vocabulary.NPX;

import java.security.*;
import java.security.spec.KeySpec;
import java.security.spec.X509EncodedKeySpec;
import java.util.List;

/**
 * Utility class for handling legacy nanopub signatures.
 */
public class LegacySignatureUtils {

    private LegacySignatureUtils() {
    }  // no instances allowed

    /**
     * Extracts the signature element from a nanopub.
     *
     * @param nanopub the nanopub to extract the signature element from
     * @return the extracted NanopubSignatureElement, or null if no signature element is found
     * @throws org.nanopub.extra.security.MalformedCryptoElementException if the signature element is malformed
     */
    public static NanopubSignatureElement getSignatureElement(Nanopub nanopub) throws MalformedCryptoElementException {
<span class="fc" id="L45">        IRI signatureUri = getSignatureElementUri(nanopub);</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">        if (signatureUri == null) return null;</span>
<span class="nc" id="L47">        NanopubSignatureElement se = new NanopubSignatureElement(nanopub.getUri(), signatureUri);</span>

<span class="nc bnc" id="L49" title="All 2 branches missed.">        for (Statement st : nanopub.getHead()) se.addTargetStatement(st);</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">        for (Statement st : nanopub.getAssertion()) se.addTargetStatement(st);</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">        for (Statement st : nanopub.getProvenance()) se.addTargetStatement(st);</span>

<span class="nc bnc" id="L53" title="All 2 branches missed.">        for (Statement st : nanopub.getPubinfo()) {</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">            if (!st.getSubject().equals(signatureUri)) {</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">                if (!st.getPredicate().equals(NPX.HAS_SIGNATURE_ELEMENT)) {</span>
<span class="nc" id="L56">                    se.addTargetStatement(st);</span>
                }
                continue;
            }
<span class="nc bnc" id="L60" title="All 2 branches missed.">            if (st.getPredicate().equals(NPX.HAS_SIGNATURE)) {</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">                if (!(st.getObject() instanceof Literal)) {</span>
<span class="nc" id="L62">                    throw new MalformedCryptoElementException(&quot;Literal expected as signature: &quot; + st.getObject());</span>
                }
<span class="nc" id="L64">                se.setSignatureLiteral((Literal) st.getObject());</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            } else if (st.getPredicate().equals(NPX.HAS_PUBLIC_KEY)) {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                if (!(st.getObject() instanceof Literal)) {</span>
<span class="nc" id="L67">                    throw new MalformedCryptoElementException(&quot;Literal expected as public key: &quot; + st.getObject());</span>
                }
<span class="nc" id="L69">                se.setPublicKeyLiteral((Literal) st.getObject());</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            } else if (st.getPredicate().equals(NPX.SIGNED_BY)) {</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">                if (!(st.getObject() instanceof IRI)) {</span>
<span class="nc" id="L72">                    throw new MalformedCryptoElementException(&quot;URI expected as signer: &quot; + st.getObject());</span>
                }
<span class="nc" id="L74">                se.addSigner((IRI) st.getObject());</span>
            } else {
<span class="nc" id="L76">                se.addTargetStatement(st);</span>
            }
<span class="nc" id="L78">        }</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (se.getSignature() == null) {</span>
<span class="nc" id="L80">            throw new MalformedCryptoElementException(&quot;Signature element without signature&quot;);</span>
        }
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (se.getPublicKeyString() == null) {</span>
<span class="nc" id="L83">            throw new MalformedCryptoElementException(&quot;Signature element without public key&quot;);</span>
        }
<span class="nc" id="L85">        se.setAlgorithm(SignatureAlgorithm.DSA);</span>
<span class="nc" id="L86">        return se;</span>
    }

    /**
     * Checks if the given NanopubSignatureElement has a valid signature.
     *
     * @param se the NanopubSignatureElement to check
     * @return true if the signature is valid, false otherwise
     * @throws java.security.GeneralSecurityException if there is an error in the cryptographic operations
     */
    public static boolean hasValidSignature(NanopubSignatureElement se) throws GeneralSecurityException {
<span class="nc" id="L97">        String artifactCode = TrustyUriUtils.getArtifactCode(se.getTargetNanopubUri().toString());</span>
<span class="nc" id="L98">        List&lt;Statement&gt; statements = RdfPreprocessor.run(se.getTargetStatements(), artifactCode);</span>
<span class="nc" id="L99">        Signature signature = Signature.getInstance(&quot;SHA1withDSA&quot;);</span>
<span class="nc" id="L100">        KeySpec publicSpec = new X509EncodedKeySpec(DatatypeConverter.parseBase64Binary(se.getPublicKeyString()));</span>
<span class="nc" id="L101">        PublicKey publicKey = KeyFactory.getInstance(&quot;DSA&quot;).generatePublic(publicSpec);</span>
<span class="nc" id="L102">        signature.initVerify(publicKey);</span>
        // Legacy signatures apply double digesting:
<span class="nc" id="L104">        signature.update(RdfHasher.digest(statements).digest());</span>
<span class="nc" id="L105">        return signature.verify(se.getSignature());</span>
    }

    /**
     * Creates a signed nanopub from a preNanopub and a key pair and signer IRI.
     *
     * @param preNanopub the nanopub to sign
     * @param key        the key pair to sign with
     * @param signer     the IRI of the signer
     * @return the signed nanopub
     * @throws java.security.GeneralSecurityException    if there is an error in the cryptographic operations
     * @throws org.eclipse.rdf4j.rio.RDFHandlerException if there is an error in handling RDF
     * @throws net.trustyuri.TrustyUriException          if there is an error in handling URIs
     * @throws org.nanopub.MalformedNanopubException     if the nanopub is malformed
     */
    public static Nanopub createSignedNanopub(Nanopub preNanopub, KeyPair key, IRI signer)
            throws GeneralSecurityException, RDFHandlerException, TrustyUriException, MalformedNanopubException {
<span class="nc" id="L122">        Signature dsaSignature = Signature.getInstance(&quot;SHA1withDSA&quot;);</span>
<span class="nc" id="L123">        dsaSignature.initSign(key.getPrivate());</span>

<span class="nc" id="L125">        RdfFileContent content = new RdfFileContent(RDFFormat.TRIG);</span>
<span class="nc" id="L126">        NanopubUtils.propagateToHandler(preNanopub, content);</span>
<span class="nc" id="L127">        content = RdfPreprocessor.run(content, preNanopub.getUri(), TrustyNanopubUtils.transformRdfSetting);</span>

        // Legacy signatures apply double digesting:
<span class="nc" id="L130">        dsaSignature.update(RdfHasher.digest(content.getStatements()).digest());</span>
<span class="nc" id="L131">        byte[] signatureBytes = dsaSignature.sign();</span>
<span class="nc" id="L132">        String signatureString = DatatypeConverter.printBase64Binary(signatureBytes);</span>

<span class="nc" id="L134">        ValueFactory vf = SimpleValueFactory.getInstance();</span>
<span class="nc" id="L135">        RdfFileContent signatureContent = new RdfFileContent(RDFFormat.TRIG);</span>
<span class="nc" id="L136">        IRI signatureElUri = vf.createIRI(preNanopub.getUri() + &quot;sig&quot;);</span>
<span class="nc" id="L137">        signatureContent.startRDF();</span>
<span class="nc" id="L138">        signatureContent.handleNamespace(NPX.PREFIX, NPX.NAMESPACE);</span>
<span class="nc" id="L139">        IRI npUri = preNanopub.getUri();</span>
<span class="nc" id="L140">        IRI piUri = preNanopub.getPubinfoUri();</span>
<span class="nc" id="L141">        signatureContent.handleStatement(vf.createStatement(npUri, NPX.HAS_SIGNATURE_ELEMENT, signatureElUri, piUri));</span>
<span class="nc" id="L142">        String publicKeyString = DatatypeConverter.printBase64Binary(key.getPublic().getEncoded()).replaceAll(&quot;\\s&quot;, &quot;&quot;);</span>
<span class="nc" id="L143">        Literal publicKeyLiteral = vf.createLiteral(publicKeyString);</span>
<span class="nc" id="L144">        signatureContent.handleStatement(vf.createStatement(signatureElUri, NPX.HAS_PUBLIC_KEY, publicKeyLiteral, piUri));</span>
<span class="nc" id="L145">        Literal signatureLiteral = vf.createLiteral(signatureString);</span>
<span class="nc" id="L146">        signatureContent.handleStatement(vf.createStatement(signatureElUri, NPX.HAS_SIGNATURE, signatureLiteral, piUri));</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (signer != null) {</span>
<span class="nc" id="L148">            signatureContent.handleStatement(vf.createStatement(signatureElUri, NPX.SIGNED_BY, signer, piUri));</span>
        }
<span class="nc" id="L150">        signatureContent.endRDF();</span>
<span class="nc" id="L151">        signatureContent = RdfPreprocessor.run(signatureContent, preNanopub.getUri(), TrustyNanopubUtils.transformRdfSetting);</span>

<span class="nc" id="L153">        RdfFileContent signedContent = new RdfFileContent(RDFFormat.TRIG);</span>
<span class="nc" id="L154">        signedContent.startRDF();</span>
<span class="nc" id="L155">        content.propagate(signedContent, false);</span>
<span class="nc" id="L156">        signatureContent.propagate(signedContent, false);</span>
<span class="nc" id="L157">        signedContent.endRDF();</span>
<span class="nc" id="L158">        NanopubRdfHandler nanopubHandler = new NanopubRdfHandler();</span>
<span class="nc" id="L159">        TransformRdf.transformPreprocessed(signedContent, preNanopub.getUri(), nanopubHandler, TrustyNanopubUtils.transformRdfSetting);</span>
<span class="nc" id="L160">        return nanopubHandler.getNanopub();</span>
    }

    private static IRI getSignatureElementUri(Nanopub nanopub) throws MalformedCryptoElementException {
<span class="fc" id="L164">        IRI signatureElementUri = null;</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">        for (Statement st : nanopub.getPubinfo()) {</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">            if (!st.getSubject().equals(nanopub.getUri())) continue;</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">            if (!st.getPredicate().equals(NPX.HAS_SIGNATURE_ELEMENT)) continue;</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (!(st.getObject() instanceof IRI)) {</span>
<span class="nc" id="L169">                throw new MalformedCryptoElementException(&quot;Signature element must be identified by URI&quot;);</span>
            }
<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (signatureElementUri != null) {</span>
<span class="nc" id="L172">                throw new MalformedCryptoElementException(&quot;Multiple signature elements found&quot;);</span>
            }
<span class="nc" id="L174">            signatureElementUri = (IRI) st.getObject();</span>
<span class="nc" id="L175">        }</span>
<span class="fc" id="L176">        return signatureElementUri;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>