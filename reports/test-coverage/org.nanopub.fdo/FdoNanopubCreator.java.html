<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FdoNanopubCreator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nanopub</a> &gt; <a href="index.source.html" class="el_package">org.nanopub.fdo</a> &gt; <span class="el_source">FdoNanopubCreator.java</span></div><h1>FdoNanopubCreator.java</h1><pre class="source lang-java linenums">package org.nanopub.fdo;

import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.Statement;
import org.eclipse.rdf4j.model.ValueFactory;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.eclipse.rdf4j.model.vocabulary.PROV;
import org.eclipse.rdf4j.model.vocabulary.RDF;
import org.nanopub.MalformedNanopubException;
import org.nanopub.Nanopub;
import org.nanopub.NanopubCreator;
import org.nanopub.fdo.rest.HandleResolver;
import org.nanopub.fdo.rest.gson.ParsedJsonResponse;
import org.nanopub.fdo.rest.gson.Value;
import org.nanopub.trusty.TempUriReplacer;
import org.nanopub.vocabulary.NPX;

import java.io.IOException;
import java.net.URISyntaxException;
import java.util.Random;

import static org.nanopub.fdo.FdoUtils.*;

/**
 * Utility class for creating Nanopubs from FDO records.
 */
<span class="nc" id="L27">public class FdoNanopubCreator {</span>

    /**
     * Prefix for FDO type IRIs.
     */
    public static final String FDO_TYPE_PREFIX = &quot;https://w3id.org/kpxl/handle/terms/&quot;;

<span class="fc" id="L34">    private static final ValueFactory vf = SimpleValueFactory.getInstance();</span>

<span class="fc" id="L36">    private static final Random random = new Random();</span>

    /**
     * Creates a NanopubCreator with the given FdoRecord and the FDO IRI.
     *
     * @param fdoRecord the FdoRecord to be included in the Nanopub
     * @param fdoIri    the IRI of the FDO record
     * @return a NanopubCreator instance ready to create a Nanopub
     */
    public static NanopubCreator createWithFdoIri(FdoRecord fdoRecord, IRI fdoIri) {
<span class="fc" id="L46">        IRI npIri = vf.createIRI(TempUriReplacer.tempUri + Math.abs(random.nextInt()) + &quot;/&quot;);</span>
<span class="fc" id="L47">        return prepareNanopubCreator(fdoRecord, fdoIri, npIri);</span>
    }

    /**
     * Creates a NanopubCreator with the given FdoRecord and a FDO suffix.
     *
     * @param fdoRecord the FdoRecord to be included in the Nanopub
     * @param fdoSuffix the suffix to be appended to the FDO IRI
     * @return a NanopubCreator instance ready to create a Nanopub
     */
    public static NanopubCreator createWithFdoSuffix(FdoRecord fdoRecord, String fdoSuffix) {
<span class="fc" id="L58">        String npIriString = TempUriReplacer.tempUri + Math.abs(random.nextInt()) + &quot;/&quot;;</span>
<span class="fc" id="L59">        String fdoIriString = npIriString + fdoSuffix;</span>
<span class="fc" id="L60">        IRI fdoIri = vf.createIRI(fdoIriString);</span>
<span class="fc" id="L61">        IRI npIri = vf.createIRI(npIriString);</span>

<span class="fc" id="L63">        return prepareNanopubCreator(fdoRecord, fdoIri, npIri);</span>
    }

    static NanopubCreator prepareNanopubCreator(FdoRecord fdoRecord, IRI fdoIri, IRI npIri) {
<span class="fc" id="L67">        fdoRecord.setId(fdoIri);</span>
<span class="fc" id="L68">        NanopubCreator creator = new NanopubCreator(npIri);</span>
<span class="fc" id="L69">        creator.addDefaultNamespaces();</span>
<span class="fc" id="L70">        creator.addNamespace(&quot;fdof&quot;, &quot;https://w3id.org/fdof/ontology#&quot;);</span>
<span class="fc" id="L71">        creator.addAssertionStatement(fdoIri, RDF.TYPE, FdoUtils.RDF_TYPE_FDO);</span>
<span class="fc" id="L72">        creator.addPubinfoStatement(npIri, NPX.INTRODUCES, fdoIri);</span>
<span class="fc" id="L73">        creator.addAssertionStatements(fdoRecord.buildStatements().toArray(new Statement[0]));</span>

<span class="fc" id="L75">        return creator;</span>
    }

    /**
     * Creation of Nanopub from the handle system.
     *
     * @param id the handle system identifier
     * @return Nanopub containing the data from the handle system
     * @throws org.nanopub.MalformedNanopubException if the Nanopub cannot be created due to malformed data
     * @throws java.net.URISyntaxException           if the handle system identifier is not a valid URI
     * @throws java.io.IOException                   if there is an error during the HTTP request to the handle system
     * @throws java.lang.InterruptedException        if the thread is interrupted while waiting for the HTTP request to complete
     */
    public static Nanopub createFromHandleSystem(String id) throws MalformedNanopubException, URISyntaxException, IOException, InterruptedException {
<span class="fc" id="L89">        FdoRecord record = createFdoRecordFromHandleSystem(id);</span>

<span class="fc" id="L91">        IRI fdoIri = FdoUtils.createIri(id);</span>
<span class="fc" id="L92">        NanopubCreator creator = createWithFdoIri(record, fdoIri);</span>
<span class="fc" id="L93">        creator.addProvenanceStatement(PROV.WAS_DERIVED_FROM, vf.createIRI(HandleResolver.BASE_URI + id));</span>
<span class="fc" id="L94">        return creator.finalizeNanopub(true);</span>
    }

    /**
     * Creates an FdoRecord from a handle system identifier.
     *
     * @param id the handle system identifier
     * @return FdoRecord containing the data from the handle system
     * @throws java.net.URISyntaxException    if the handle system identifier is not a valid URI
     * @throws java.io.IOException            if there is an error during the HTTP request to the handle system
     * @throws java.lang.InterruptedException if the thread is interrupted while waiting for the HTTP request to complete
     */
    public static FdoRecord createFdoRecordFromHandleSystem(String id) throws URISyntaxException, IOException, InterruptedException {
<span class="fc" id="L107">        ParsedJsonResponse response = new HandleResolver().call(id);</span>
<span class="fc" id="L108">        FdoRecord record = initFdoRecord(response);</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">        for (Value v : response.values) {</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">            if (v.type.equals(DATA_REF_HANDLE)) {</span>
<span class="nc" id="L112">                record.setAttribute(DATA_REF_IRI, vf.createIRI(String.valueOf(v.data.value)));</span>
<span class="nc" id="L113">                continue;</span>
            }
<span class="fc bfc" id="L115" title="All 6 branches covered.">            if (!v.type.equals(&quot;HS_ADMIN&quot;) &amp;&amp; !v.type.equals(&quot;name&quot;) &amp;&amp; !v.type.equals(&quot;id&quot;) &amp;&amp;</span>
<span class="pc bpc" id="L116" title="1 of 6 branches missed.">                    !v.type.equals(PROFILE_HANDLE) &amp;&amp; !v.type.equals(PROFILE_HANDLE_1) &amp;&amp; !v.type.equals(PROFILE_HANDLE_2)) {</span>
                // TODO later remove PROFILE_HANDLE_1 and PROFILE_HANDLE_2
<span class="fc" id="L118">                String dataValue = String.valueOf(v.data.value);</span>
                String dataValueToImport;
<span class="fc bfc" id="L120" title="All 2 branches covered.">                if (looksLikeHandle(dataValue)) {</span>
<span class="fc" id="L121">                    dataValueToImport = toIri(dataValue).stringValue();</span>
                } else {
<span class="fc" id="L123">                    dataValueToImport = dataValue;</span>
                }
                IRI fdoHandleIri;
<span class="fc bfc" id="L126" title="All 2 branches covered.">                if (v.type.contains(&quot;/&quot;)) {</span>
<span class="fc" id="L127">                    fdoHandleIri = vf.createIRI(FDO_URI_PREFIX + v.type);</span>
                } else {
<span class="fc" id="L129">                    fdoHandleIri = vf.createIRI(FDO_TYPE_PREFIX + v.type);</span>
                }
<span class="fc bfc" id="L131" title="All 2 branches covered.">                if (looksLikeUrl(dataValueToImport)) {</span>
<span class="fc" id="L132">                    record.setAttribute(fdoHandleIri, vf.createIRI(dataValueToImport));</span>
                } else {
<span class="fc" id="L134">                    record.setAttribute(fdoHandleIri, vf.createLiteral(dataValueToImport));</span>
                }
            }
        }
<span class="fc" id="L138">        return record;</span>
    }

    private static FdoRecord initFdoRecord(ParsedJsonResponse response) {
<span class="fc" id="L142">        String label = null;</span>
<span class="fc" id="L143">        IRI profile = null;</span>

<span class="fc bfc" id="L145" title="All 2 branches covered.">        for (Value v : response.values) {</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">            if (v.type.equals(&quot;name&quot;)) {</span>
<span class="fc" id="L147">                label = String.valueOf(v.data.value);</span>
            }
<span class="pc bpc" id="L149" title="1 of 6 branches missed.">            if (v.type.equals(PROFILE_HANDLE) || v.type.equals(PROFILE_HANDLE_1) || v.type.equals(PROFILE_HANDLE_2)) {</span>
                // TODO later remove PROFILE_HANDLE_1 and PROFILE_HANDLE_2
<span class="fc" id="L151">                String profileValue = String.valueOf(v.data.value);</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">                if (looksLikeHandle(profileValue)) {</span>
<span class="fc" id="L153">                    profile = toIri(profileValue);</span>
                } else {
<span class="nc" id="L155">                    profile = vf.createIRI(profileValue);</span>
                }
            }
        }

<span class="fc" id="L160">        return new FdoRecord(profile, label, null);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>