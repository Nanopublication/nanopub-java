<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NanopubIndexCreator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nanopub</a> &gt; <a href="index.source.html" class="el_package">org.nanopub.extra.index</a> &gt; <span class="el_source">NanopubIndexCreator.java</span></div><h1>NanopubIndexCreator.java</h1><pre class="source lang-java linenums">package org.nanopub.extra.index;

import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.vocabulary.*;
import org.eclipse.rdf4j.rio.turtle.TurtleUtil;
import org.nanopub.Nanopub;
import org.nanopub.NanopubCreator;
import org.nanopub.trusty.TempUriReplacer;
import org.nanopub.vocabulary.NP;
import org.nanopub.vocabulary.NPX;
import org.nanopub.vocabulary.PAV;

import java.util.HashMap;
import java.util.Map;
import java.util.Random;

/**
 * This class is used to create nanopublication indexes.
 */
public abstract class NanopubIndexCreator {

<span class="nc" id="L22">    private IRI completeIndexUri = null;</span>
<span class="nc" id="L23">    private boolean finalized = false;</span>

    private NanopubCreator npCreator;
    private int itemCount;
    private Map&lt;String, Integer&gt; elementNs;
    private int elementNsCount;
    private IRI previousIndexUri;
    private IRI supersededIndexUri;
    private boolean makeTrusty;
<span class="nc" id="L32">    private Random random = new Random();</span>

    /**
     * Creates a new NanopubIndexCreator with the option to make the nanopublications trusty.
     *
     * @param makeTrusty If true, the created nanopublications will be trusty.
     */
    public NanopubIndexCreator(boolean makeTrusty) {
<span class="nc" id="L40">        this(null, makeTrusty);</span>
<span class="nc" id="L41">    }</span>

    /**
     * Creates a new NanopubIndexCreator with the option to make the nanopublications trusty and
     * the previous index URI.
     *
     * @param previousIndexUri The URI of a previous index.
     * @param makeTrusty       If true, the created nanopublications will be trusty.
     */
<span class="nc" id="L50">    public NanopubIndexCreator(IRI previousIndexUri, boolean makeTrusty) {</span>
<span class="nc" id="L51">        this.previousIndexUri = previousIndexUri;</span>
<span class="nc" id="L52">        this.makeTrusty = makeTrusty;</span>
<span class="nc" id="L53">    }</span>

    /**
     * Adds a nanopublication.
     *
     * @param np The nanopublication to add.
     */
    public void addElement(Nanopub np) {
<span class="nc" id="L61">        addElement(np.getUri());</span>
<span class="nc" id="L62">    }</span>

    /**
     * Adds a nanopublication by its URI.
     *
     * @param npUri The URI of the nanopublication to add.
     */
    public void addElement(IRI npUri) {
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (finalized) throw new RuntimeException(&quot;Already finalized&quot;);</span>
<span class="nc bnc" id="L71" title="All 4 branches missed.">        if (npCreator == null || itemCount &gt;= NanopubIndex.MAX_SIZE) {</span>
<span class="nc" id="L72">            newNpCreator();</span>
        }
<span class="nc" id="L74">        itemCount++;</span>
<span class="nc" id="L75">        npCreator.addAssertionStatement(npCreator.getNanopubUri(), NPX.INCLUDES_ELEMENT, npUri);</span>
<span class="nc" id="L76">        int nsSplit = TurtleUtil.findURISplitIndex(npUri.toString());</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (nsSplit &gt; 0) {</span>
<span class="nc" id="L78">            String ns = npUri.toString().substring(0, nsSplit);</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">            if (!elementNs.containsKey(ns)) {</span>
<span class="nc" id="L80">                elementNs.put(ns, 1);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">            } else if (elementNs.get(ns) == 1) {</span>
                // only add namespace if at least 2 elements share it
<span class="nc" id="L83">                elementNsCount++;</span>
<span class="nc" id="L84">                npCreator.addNamespace(&quot;ns&quot; + elementNsCount, ns);</span>
<span class="nc" id="L85">                elementNs.put(ns, 2);</span>
            }
        }
<span class="nc" id="L88">    }</span>

    /**
     * Adds a sub-index to the current index.
     *
     * @param npc The nanopublication index to add as a sub-index.
     */
    public void addSubIndex(NanopubIndex npc) {
<span class="nc" id="L96">        addSubIndex(npc.getUri());</span>
<span class="nc" id="L97">    }</span>

    /**
     * Adds a sub-index to the current index by its URI.
     *
     * @param npcUri The URI of the nanopublication index to add as a sub-index.
     */
    public void addSubIndex(IRI npcUri) {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (finalized) throw new RuntimeException(&quot;Already finalized&quot;);</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">        if (npCreator == null || itemCount &gt;= NanopubIndex.MAX_SIZE) {</span>
<span class="nc" id="L107">            newNpCreator();</span>
        }
<span class="nc" id="L109">        itemCount++;</span>
<span class="nc" id="L110">        npCreator.addAssertionStatement(npCreator.getNanopubUri(), NPX.INCLUDES_SUBINDEX, npcUri);</span>
<span class="nc" id="L111">    }</span>

    /**
     * Sets the superseded index URI for the current index.
     *
     * @param npc The nanopublication index that is superseded.
     */
    public void setSupersededIndex(NanopubIndex npc) {
<span class="nc" id="L119">        setSupersededIndex(npc.getUri());</span>
<span class="nc" id="L120">    }</span>

    /**
     * Sets the superseded index URI for the current index by its URI.
     *
     * @param npcUri The URI of the nanopublication index that is superseded.
     */
    public void setSupersededIndex(IRI npcUri) {
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (finalized) throw new RuntimeException(&quot;Already finalized&quot;);</span>
<span class="nc" id="L129">        supersededIndexUri = npcUri;</span>
<span class="nc" id="L130">    }</span>

    /**
     * Finalizes the nanopublication, making it immutable and ready for use.
     */
    public void finalizeNanopub() {
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (finalized) throw new RuntimeException(&quot;Already finalized&quot;);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (npCreator == null) {</span>
<span class="nc" id="L138">            newNpCreator();</span>
        }
<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (supersededIndexUri != null) {</span>
<span class="nc" id="L141">            npCreator.addPubinfoStatement(npCreator.getNanopubUri(), NPX.SUPERSEDES, supersededIndexUri);</span>
        }
<span class="nc" id="L143">        enrichCompleteIndex(npCreator);</span>
        try {
            Nanopub np;
<span class="nc bnc" id="L146" title="All 2 branches missed.">            if (makeTrusty) {</span>
<span class="nc" id="L147">                np = npCreator.finalizeTrustyNanopub(true);</span>
            } else {
<span class="nc" id="L149">                np = npCreator.finalizeNanopub(true);</span>
            }
<span class="nc" id="L151">            completeIndexUri = np.getUri();</span>
<span class="nc" id="L152">            handleCompleteIndex(IndexUtils.castToIndex(np));</span>
<span class="nc" id="L153">        } catch (Exception ex) {</span>
<span class="nc" id="L154">            throw new RuntimeException(ex);</span>
<span class="nc" id="L155">        }</span>
<span class="nc" id="L156">        finalized = true;</span>
<span class="nc" id="L157">    }</span>

    /**
     * Returns the URI of the complete index nanopublication.
     *
     * @return The URI of the complete index nanopublication, or null if not finalized.
     */
    public IRI getCompleteIndexUri() {
<span class="nc" id="L165">        return completeIndexUri;</span>
    }

    /**
     * This method should return the base URI of the nanopublication index. This should ideally
     * be the URL of a nanopub server, such as &lt;a href=&quot;http://np.inn.ac/&quot;&gt;...&lt;/a&gt;, which makes the resulting
     * trusty URIs resolvable.
     *
     * @return The base URI as a string.
     */
    public abstract String getBaseUri();

    /**
     * This method gives access to the creation of &quot;incomplete&quot; index nanopublications before they
     * are finalized (and thereby made immutable). This method is useful to add publication info
     * and provenance triples. Incomplete indexes are the ones that are appended by other indexes,
     * and for that reason do not stand for a meaningful set on their own. Provenance and
     * publication information is less important for incomplete indexes than for complete ones,
     * and this method can also be ignored completely (i.e. left empty).
     *
     * @param npCreator Access to a partially created incomplete nanopublication in the form of
     *                  a NanopubCreator object.
     */
    public abstract void enrichIncompleteIndex(NanopubCreator npCreator);

    /**
     * This method gives access to the creation of the &quot;complete&quot; index nanopublications before it
     * is finalized (and thereby made immutable). This method is useful to add publication info
     * and provenance triples. Complete indexes are the ones that stand for a meaningful set on
     * their own and are typically not appended by other indexes. As the nanopublications
     * themselves have their own provenance and publication information, it can be sufficient
     * give only minimal additional information here.
     *
     * @param npCreator Access to the partially created complete nanopublication in the form of
     *                  a NanopubCreator object.
     */
    public abstract void enrichCompleteIndex(NanopubCreator npCreator);

    /**
     * With this method, newly created &quot;incomplete&quot; nanopublication indexes are announced.
     * Incomplete indexes are appended by other (incomplete or complete) indexes. This method
     * can forward them or write them to a file.
     *
     * @param npi The newly created incomplete nanopublication index.
     */
    public abstract void handleIncompleteIndex(NanopubIndex npi);

    /**
     * With this method, the newly created &quot;complete&quot; nanopublication indexe is announced.
     * This complete index is the final one standing for the entire set. This method can forward
     * it or write it to a file. Note that all incomplete indexes need to be available in order
     * to make sense of a complete index.
     *
     * @param npi The newly created complete nanopublication index.
     */
    public abstract void handleCompleteIndex(NanopubIndex npi);

    /**
     * This method is called to create a new nanopublication index. It finalizes the existing
     * index nanopub (if any) and initializes a new one.
     */
    private void newNpCreator() {
        // Finalize existing index nanopub:
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (npCreator != null) {</span>
<span class="nc" id="L229">            npCreator.addPubinfoStatement(RDF.TYPE, NPX.INCOMPLETE_INDEX);</span>
<span class="nc" id="L230">            enrichIncompleteIndex(npCreator);</span>
            try {
                Nanopub np;
<span class="nc bnc" id="L233" title="All 2 branches missed.">                if (makeTrusty) {</span>
<span class="nc" id="L234">                    np = npCreator.finalizeTrustyNanopub(true);</span>
                } else {
<span class="nc" id="L236">                    np = npCreator.finalizeNanopub(true);</span>
                }
<span class="nc" id="L238">                previousIndexUri = np.getUri();</span>
<span class="nc" id="L239">                handleIncompleteIndex(IndexUtils.castToIndex(np));</span>
<span class="nc" id="L240">            } catch (Exception ex) {</span>
<span class="nc" id="L241">                throw new RuntimeException(ex);</span>
<span class="nc" id="L242">            }</span>
        }
        // Initialize new index nanopub:
<span class="nc" id="L245">        elementNs = new HashMap&lt;&gt;();</span>
<span class="nc" id="L246">        elementNsCount = 0;</span>
<span class="nc" id="L247">        itemCount = 0;</span>
<span class="nc" id="L248">        String baseUri = getBaseUri();</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (baseUri.startsWith(TempUriReplacer.tempUri)) {</span>
<span class="nc" id="L250">            baseUri += Math.abs(random.nextLong()) + &quot;/&quot;;</span>
        }
<span class="nc" id="L252">        npCreator = new NanopubCreator(baseUri);</span>
<span class="nc" id="L253">        npCreator.addNamespace(&quot;&quot;, baseUri);</span>
<span class="nc" id="L254">        npCreator.addNamespace(RDF.NS);</span>
<span class="nc" id="L255">        npCreator.addNamespace(RDFS.NS);</span>
<span class="nc" id="L256">        npCreator.addNamespace(XSD.NS);</span>
<span class="nc" id="L257">        npCreator.addNamespace(OWL.NS);</span>
<span class="nc" id="L258">        npCreator.addNamespace(&quot;dct&quot;, DCTERMS.NAMESPACE);</span>
<span class="nc" id="L259">        npCreator.addNamespace(&quot;dce&quot;, DC.NAMESPACE);</span>
<span class="nc" id="L260">        npCreator.addNamespace(PAV.PREFIX, PAV.NAMESPACE);</span>
<span class="nc" id="L261">        npCreator.addNamespace(NP.PREFIX, NP.NAMESPACE);</span>
<span class="nc" id="L262">        npCreator.addNamespace(NPX.PREFIX, NPX.NAMESPACE);</span>
<span class="nc" id="L263">        npCreator.addProvenanceStatement(RDF.TYPE, NPX.INDEX_ASSERTION);</span>
<span class="nc" id="L264">        npCreator.addPubinfoStatement(RDF.TYPE, NPX.NANOPUB_INDEX);</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (previousIndexUri != null) {</span>
<span class="nc" id="L266">            npCreator.addAssertionStatement(npCreator.getNanopubUri(), NPX.APPENDS_INDEX, previousIndexUri);</span>
        }
<span class="nc" id="L268">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>